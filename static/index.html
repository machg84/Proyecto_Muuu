<!DOCTYPE html>
<html>
<head>
  <title>Ubicación en vivo - Google Maps</title>
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <h2>Ubicación en tiempo real</h2>
  <label>
    <input type="checkbox" id="mostrarRutas">
    Mostrar rutas
  </label>
  <div id="map"></div>

  <script>
    let map;
    const marcadores = {};  // ID → marcador
    const rutas = {};       // ID → array de puntos
    const polilineas = {};  // ID → polilínea

    const colores = ["#FF0000", "#0000FF", "#00FF00", "#FFA500", "#800080", "#00FFFF", "#FFC0CB"];
    const coloresPorID = {}; // ID → color asignado

    function initMap() {
      const centro = { lat: -33.4263, lng: -70.5728 };
      map = new google.maps.Map(document.getElementById("map"), {
        center: centro,
        zoom: 19,
      });

      setInterval(obtenerUbicaciones, 3000);
    }

    function obtenerUbicaciones() {
      fetch("coordenadas.json")
        .then(response => response.json())
        .then(data => {
          data.forEach((item, index) => {
            const id = item.id;
            const posicion = { lat: item.lat, lng: item.lng };

            // Asignar color si no está definido
            if (!coloresPorID[id]) {
              coloresPorID[id] = colores[Object.keys(coloresPorID).length % colores.length];
            }

            // Actualizar o crear marcador
            if (marcadores[id]) {
              marcadores[id].setPosition(posicion);
            } else {
              marcadores[id] = new google.maps.Marker({
              position: posicion,
              map: map,
              title: `ID: ${id}`,
              label: {
                text: id,
                color: "#000000",
                fontSize: "12px",
                fontWeight: "bold"
              },
              icon: {
                url: "/static/vaca.png",  // si está en la misma carpeta que index.html
                scaledSize: new google.maps.Size(60, 34),       // imagen 30% más pequeña
                anchor: new google.maps.Point(30, 17),          // nuevo centro
                labelOrigin: new google.maps.Point(30, 42)      // nuevo punto debajo del ícono
              }
            });
            }

            // Guardar ruta y actualizar línea
            if (!rutas[id]) rutas[id] = [];
            rutas[id].push(posicion);

            const mostrar = document.getElementById("mostrarRutas").checked;

            if (polilineas[id]) {
              polilineas[id].setMap(null); // Elimina línea anterior
            }

            if (mostrar) {
              polilineas[id] = new google.maps.Polyline({
                path: rutas[id],
                geodesic: true,
                strokeColor: coloresPorID[id],
                strokeOpacity: 1.0,
                strokeWeight: 2,
              });
              polilineas[id].setMap(map);
            } else {
              polilineas[id] = null;
            }
          });
        });
    }
  </script>

  <!-- Reemplaza TU_API_KEY con tu clave -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvyOFOIrug9iAPyF-flKntXIFCjQgG_JQ&callback=initMap" async defer></script>
</body>
</html>